# Типовые операции по администрированию комплекса

## Генерация промокодов

### Общая информация

На данный момент промокоды могут быть одного из двух типов:

* тип 1 - персональный или пользовательский - используя промокод этого типа при регистрации пользователя получаем одиночного (простого) пользователя;
* тип 2 - групповой - используя промокод этого типа при регистрации пользователя получаем группового пользователя - администратора группы, который после входа в систему может через панель администрирования регистрировать одиночных (простых) пользователей самостоятельно в пределах установленных тарифами ограничений.

### Генерация

Операция выполняется на носителе роли `be` в два этапа:

1. Непосредственно генерация промокодов в базе данных:
```
cd /usr/local/lib64/perl5/PSync/API
./generate_promo_codes.pl --add_login_promocodes --count=<требуемое количество промокодов> --promocode_type=<тип промокода - 1 или 2> --promocode_name='<имя пакета промокодов - должно быть уникальным в пределах комплекса>'
```

2. Получение значений промокодов для передачи заказчику:
```
cd /usr/local/lib64/perl5/PSync/API
./generate_promo_codes.pl --get_promocodes='<имя пакета промокодов из п.1>'
```

## Операции с групповыми тарифами.

### Обшая информация

Тарифы - это наборы ограничительных параметров (квот) применяемые к групповым (корпоративным) пользователям. Ограничения действуют на всех пользователей организации (группы) суммарно.

Одному пользователю может быть одновременно назначено несколько тарифов.

На данный момент имеется две группы тарифов, несовместимые между собой, т.е. одному пользователю могут быть назначены тарифы только из одной группы.

| Группа 1 | Группа 2 |
|---|---|
| corp_1 | MosReg |
| user_1 | MosReg2 |

### Операции

Все операции с тарифами выполняются на ноде-носителе роли `be` в папке /usr/local/lib64/perl5/NCT/WebAdminAPI

1. Создание группового пользователя с одновременным присвоением тарифа:
```
./adminapi_script.pl --create_corp_user='login=<логин группового (корпоративного) пользователя>&password=<пароль пользователя>&tariff=<тарифы через запятую>'
```

2. Просмотр действующих тарифов:
```
./adminapi_script.pl --list_group_tariffs='login=<логин группового (корпоративного) пользователя>'
```

3. Добавление тарифа уже имеющемуся групповому (корпоративному) пользователю:
```
./adminapi_script.pl --add_and_activate_corp_tariffs='login=<логин группового (корпоративного) пользователя>&tariffs=<добавляемые тарифы (через запятую)>'
```

4. Удаление тарифа у имеющегося корпоративного пользователя:
```
./adminapi_script.pl --deactivate_group_tariffs='login=<логин группового (корпоративного) пользователя>&tariffs=<добавляемые тарифы (через запятую)>'
```

## Низкоуровневые операции с тарифами

### Общая информация

Для выполнении низкоуровневых операций необходимо с ноды-носителя роли `be` подключиться к мастер-серверу PostgreSQL, к базе FS с авторизационными данными пользователя FS. Эта информация берётся из файла /usr/local/lib64/perl5/PSync/API/.config.inc
Каждый тариф состоит из определённого набора параметров (features), описанного в поле props таблицы tariffs в формате JSON.

### Просмотр всех тарифов, имеющихся в системе:
```
fs_22-15=# select * from tariffs;
 tariff_id |  mnem  |             name             | start_time |  end_time   | is_active | is_corp | is_incremental |                                props                                 
-----------+--------+------------------------------+------------+-------------+-----------+---------+----------------+----------------------------------------------------------------------
 corp_1    | corp_1 | Default corp tariff          |          0 | 32503670000 | t         | t       | f              | {"features":{"1":5368709120,"2":10}}
 MosReg    | mosreg | MosReg corp tariff. Main     |          0 | 32503670000 | t         | t       | f              | {"features":{"5":10000,"2":10000}}
 MosReg2   | mosre2 | MosReg corp tariff. Addition |          0 | 32503670000 | t         | t       | f              | {"features":{"6":100}}
 user_1    | user_1 | Default user tariff          |          0 | 32503670000 | t         | f       | f              | {"features":{"1":5368709120}}
 test_t_01 | test01 | Test tariff 01               |          0 | 32503670000 | t         | t       | f              | {"features":{"2":50,"12":1,"22":1,"1":100000000},"duration":8640000}
 test_t_03 | test03 | Test tariff 03               |          0 | 32503670000 | t         | t       | f              | {"features":{"2":25,"22":0,"1":300000000}}
 test_t_04 | test04 | Test tariff 04               |          0 | 32503670000 | f         | t       | f              | 
 test_t_05 | test05 | Test tariff 05               |          0 | 32503670000 | t         | f       | f              | {"features":{"1":400000000}}
 test_t_06 | test06 | Test tariff 06               |          0 | 32503670000 | t         | f       | f              | {"features":{"1":800000000}}
 test_t_02 | test02 | Test tariff 02               |          0 | 32503670000 | t         | t       | f              | {"features":{"1":200000000,"22":1,"2":100}}
(10 rows)
```

### Просмотр доступных для управления параметров тарифов (features)
```
fs_22-15=# select * from features where type=11;
 feature_id | mnem | type |                    name                     | descr | props 
------------+------+------+---------------------------------------------+-------+-------
          1 | 1    |   11 | Дисковое пространство                       |       | 
          2 | 2    |   11 | Количество пользователей                    |       | 
          3 | 3    |   11 | Количество мобильных устройств              |       | 
          5 | 5    |   11 | Пакет 2 GB на пользователя. не более одного |       | 
          6 | 6    |   11 | Пакет 4 GB на пользователя. не более одного |       | 
(5 rows)
```

### Просмотр тарифов, действующих на определённого пользователя
```
fs_22-15=# select * from tariffs where tariff_id IN(select tariff_id from group_tariffs where group_id IN(select group_id from group_users where user_id IN(select user_id from users where login='pastordidi@22-15.myoffice.ru')));
 tariff_id |  mnem  |        name         | start_time |  end_time   | is_active | is_corp | is_incremental |             props             
-----------+--------+---------------------+------------+-------------+-----------+---------+----------------+-------------------------------
 user_1    | user_1 | Default user tariff |          0 | 32503670000 | t         | f       | f              | {"features":{"1":5368709120}}
(1 row)
```

После изменения,добавления INSERT/UPDATE SQL запросами каких либо параметров отдельных тарифов, либо самих тарифов целиком, для немедленной активации внесённых изменений нужно отключиться от PostgreSQL (команда `\q`) и выполнить команды:
```
cd /usr/local/lib64/perl5/NCT/WebAdminAPI
./adminapi_script.pl --cron1
```
