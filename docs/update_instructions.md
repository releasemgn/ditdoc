# 7. Инструкция по обновлению

## 7.1 Обновление с Deel Seed до Elderflower 20016.02 и Elderflower 20016.02p1 (Переход на ОС Scientific Linux 7.2).

Для обновления односерверной конфигурации:

* Сначала обратите внимание на пункт 7.1.3 в части форматирования разделов.
* Остановить все сервисы.
* Выполните только пункты: 7.1.2.5 - 7.1.2.10, 7.1.3 - 7.1.5.

### 7.1.1 Выключите все сервера ячейки и включайте их последовательно для обновления.

Перед началом обновления все сервисы должны быть остановлены, для надёжности выключите все серверы.

### 7.1.2 Обновление серверов с ролью db и ms

При обновлении серверов с ролями ms и db необходимо обеспечить сохранение имеющихся данных. Убедитесь, что у вас достаточно прав для выполнения приведённых ниже команд (либо выполняйте их с правами пользователя root)

#### 7.1.2.1 Запомните где находится Master PostgresSQL сервера. Воспользуйтесь командой `pcs status` - посмотрите на ресурс `pgsql_res` и `db_IP`

#### 7.1.2.2 Отключите ресурсы pacemaker "db_IP", "ms_pgsql_res" и "pgsql_res": 

```
pcs resource delete db_IP
pcs resource delete ms_pgsql_res
pcs resource delete pgsql_res`
```

#### 7.1.2.3 Остановите БД на серверах с репликами.

#### 7.1.2.4 Убедитесь, что БД на серверах с репликами не запущены.
 
#### 7.1.2.5 Убедитесь, что на диске мастер-сервера с ролью db имеется достаточное количество свободного места: 

* оцените объём занимаемого места домашней директорией пользователя postgres: `du -khs /var/lib/pgsql`
* оцените объём доступного на диске места (поле Avail): `df -h /`
* Объём имеющегося места должен быть не меньше объёма занимаемого места домашней директорией пользователя postgres. В противном случае требуется подключение альтернативного хранилища данных с необходимым объёмом сводобного места, чтобы была возможность сохранить дамп базы данных.

#### 7.1.2.6 Дамп всех баз данных.

```
/etc/init.d/postgresql-9.3 start
cd /usr/pgsql-9.3/bin
sudo -u postgres ./pg_dumpall -f /tmp/db.sql && echo Success || echo Fail
```

Если во время выполнения дампа  произошли какие-то ошибки, необходимо их устранить.

Запишите какие базы данных находятся на сервере. Посмотреть список можно командной `sudo -u postgres psql -l`

#### 7.1.2.7 Сохранение данных

После успешного снятия дампа базы данных сохраните полученный файл, а также директории /etc, /home/ на каком-нибудь внешнем и надёжном хранилище.

#### 7.1.2.8 Переустановка первого сервера роли db (db1).

В предыдущих версиях название окружения вычислялось из доменного имени "<окружение>.nct". Например если серверы установлены с испольщзованием внутреннего домена myenv.nct, то название окружения будет "myenv".

Начиная с релиза Elderflower название окружения по умолчанию равно "box". Чтобы переопределить его необходимо в файл /etc/puppet/manifests/custom.pp добавить строчку $env_custom="myenv". 
 
При обновлении сервера-конфигураций puppet, обратите внимание, что нельзя в новых конфигурационных файлах указывать название окружения отличное от предыдущего, тк это повлечет за собой невозможность использовать сохраненные ранее данные.

Название окружения $env полностью отвязано от домена на котором развёрнут стенд (facter domain). Вместо этого для определения внутренних имён виртуальных хостов в nginx используется переменная $interdomain, которая по умолчанию равна $domain (facter domain). Переопределить переменную $interdomain можно задав переменную $interdomain_custom в файле `/etc/puppet/manifests/custom.pp` 

Проведите установку сервера db1 в соотвествии с инструкцией по [установке сервера](procedure#install_puppetmaster) пункт *4.1*.

#### 7.1.2.9 Импорт дампа

Теперь, когда вы имеете сервер с ролью db, работающий на ОС Scientific Linux 7.2, можно провести процедуру восстановления данный из дампа. Для этого необходимо переписать сохранённый ранее дамп на настроенный сервер и выполнить команду:

```
sudo -u postgres psql -с 'DROP DATABASE fs_ВАШЕ_ОКРУЖЕНИЕ;'
sudo -u postgres psql -f db.sql
```

#### 7.1.2.10 Проверка

Выполните команду `sudo -u postgres psql -l` и сравните со списком из пункта *7.1.2.6* - все базы должны быть на месте.

После процедуры обновления сервера с ролью db, перезапустите его и убедитесь в работоспособности.

#### 7.1.2.11 Обновите остальные серверы роли db

После успешного запуска мастер-севрера, аналогичным образом обновите реплики (сохранять данные с реплик не требуется). Для этого установите Scientific Linux 7.2 и проведите установку сервера в соотвествии с инструкцией по установке сервера с ролью db (пункт *4.2* инструкции). Далее запустите команду:

```
/root/bin/restore-script.sh
```

Убедитесь, что репликация баз данных запустилась. Выполните команду `pcs status`

### 7.1.3 Обновление оставшихся серверов

Выполните переутсановку ОС и пункт *4.2* инструкции по установки со следующими отступлениями:

* Для обновления оставшихся серверов сохраните директории с каждого севрера директории /etc и /home на внешнее надёжное хранилище. 
* **Переустановку ОС для серверов роли *st* выполняйте без форматирования блочных устройств, на которых находятся метаданные фс swift**, то есть форматировать можно только диск, на котором установлена ОС.

### 7.1.4 Выполнить скрипты

На одной из нод типа be выполнить:

```
cd /usr/local/lib64/perl5/PSync/API/
./t/postgresql.t --update
cd /usr/fsapi
# Процедура --update_objects_file_names работает долго и зависит от количества файлов в системе. Её можно запустить в фоне (screen/tmux) и продолжать установку.
./bin/fix_script.pl --update_objects_file_names
./bin/fix_script.pl --fix_share_calendars
cd /usr/local/lib64/perl5/NCT/WebAdminAPI/
./adminapi_script.pl --sync_vmail_domains_into_fs
./adminapi_script.pl --delete_public_domains
```

### 7.1.5 Запустить тесты:

На одной из нод типа be выполнить:

```
export LINES=24
export COLUMNS=80
cd /usr/local/lib64/perl5/PSync/API
prove -p -v --timer
cd /usr/local/lib64/perl5/NCT/WebAdminAPI/
prove -p -v --timer
```

## 7.2 Обновление c Elderflower 2016.02 до Elderflower 2016.02p1 (Patch)

### 7.2.1 Установка

* Примонтируйте диск с дистрибутивом Мой Офис® `mount /dev/sr0 /mnt`
* Запустите установку `/mnt/scripts/install_puppetmaster.sh`
* Выполните пункт инструкции 4.1.3 [Установка конфига HIERA с помощью конфигуратора AUTO HIERA](procedure#auto_hiera)

### 7.2.2 Dnsmasq

Если у вас используется dnsmasq то рекомендуем отказаться от этой практики в пользу более надёжных DNS. dnsmasq поставляется вместе с продуктом с целью облегчения тестирования.

По умолчанию dnsmasq выключен. Чтобы включить dnsmasq обратитесь к пункту 4.1.4.13 иснтрукции.

### 7.2.3 Выполните `puppet agent -t` на сервере puppetmaster (нодa db1)

### 7.2.4 Пересоздайте ресурс pgsql_res на кластере нод роли db

* Выполните `pcs status` и определите на какой ноде Master базы данных.
* На этой ноде выполните `pcs resource delete pgsql_res`, затем `/root/bin/create_postgresql_cluster.cib`
* Убедитесь что все ноды в рабочем состоянии по выводу `pcs status`

### 7.2.5 Выполните `puppet agent -t` на всех остальных серверах

### 7.2.6 Выполните скрипт на одной ноде роли db:

```
cd /usr/local/lib64/perl5/NCT/WebAdminAPI/
./adminapi_script.pl --fix_all_resources_empty_quota
```

