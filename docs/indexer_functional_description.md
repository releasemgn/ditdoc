# Индексатор: функции, параметры запуска

## Содержание

* [Функции индексатора](#функции-индексатора)
* [Схема работы индексатора](#схема-работы-индексатора)
* [Запуск индексатора](#запуск-индексатора)
* [Параметры запуска индексатора](#параметры-запуска-индексатора)
* [Общая информация](#общая-информация)
 * `-n NUM`
 * `-s NUM`
 * `-d NUM`
 * `-p NUM`
 * `-l STR`
 * `-c STR`
 * `-m STR`
 * `-a STR`
 * `-g DOCID`
 * `-e DOCID`
 * `-E DOCID`
 * `-v DOCID`
 * `-0`
 * `-r`
 * `-i`
* [FAQ](#faq)

## Функции индексатора

Индексатор обеспечивает возможность поиска по ключевому слову среди

* документов
* писем пользователя

Рабочим форматом документов является html с кодировкой utf-8.

Обработка писем является более сложным процессом, включающим

* Определение кодировки письма
* Сборку из частей
* Работу с mime-форматами (используется библиотека mimetic-0.9.8).
* Конвертацию в рабочую кодировку

## Схема работы индексатора

Цикл работы индексатора включает последовательное выполнение следующих действий:

1. Получение документов из главной БД
2. Разделение документов на лексемы
3. Построение индекса
4. Сохранение в отдельную БД, которая используется исключительно для полнотекстового поиска

Как видно на схеме, сами тела документов хранятся не в постгресовой БД, а в отдельном хранилище, в Open Stack Swift. Из постгресовой БД извлекаются метаданные документа:

* Описание заголовка документа
* Дата его последнего обновления
* Владелец
* Идентификатор документа и т.п.

По идентификатору документа из Open Stack Swift извлекается тело документа, индексируется и помещается в другую постгресовую БД, где строится полнотекстовый индекс.

## Запуск индексатора

Индексатор обычно размещается на отдельном хосте либо на хосте, содержащем БД полнотекстового индекса.
Для запуска можно использовать обычную консольную команду:

`indexer [опции]`

На продакшне индексатор запускается как сервис (демон), который в штатном режиме должен работать постоянно:

`sudo /etc/init.d/indexer start`

## Параметры запуска индексатора

### Общая информация

Цель использования параметров при запуске индексатора - добиться, чтобы индексация происходила с минимальными задержками, чтобы изменения в индексе были видны как можно быстрее. Промежуток между редактированием документа и возможностью найти внесённые изменения должен быть минимальным.

При этом следует учитывать, что максимальные значения параметров могут создать чрезмерную нагрузку и замедлить штатную работу системы. Таким образом, необходимо соблюдать компромисс между оперативностью обновления индекса и нагрузкой на систему.

### `-n NUM`

Число работающих потоков. Чем их больше, тем быстрее происходит индексация, но тем больше нагрузка на систему. Пока больше одного (дефолтное значение) потока никогда не пускали.

### `-s NUM`

Количество одновременно запрашиваемых и индексируемых документов.

При слишком маленьком значении придётся производить больше достаточно тяжеловесных поисковых запросов для поиска документов, подлежащих индексации.

Слишком большое значение может привести к увеличению интервала обновления и необходимости повторного выполнения работы при ошибках или сбое.

Значение по умолчанию: 1000.

### `-d NUM`

Искусственная задержка индексатора между запросами - чтобы индексатор сильно не загружал систему.

Значение по умолчанию: 10 секунд.

### `-p NUM`

Приоритет индексатора. Позволяет уменьшить приоритет запросов индексатора к основной базе, чтобы уменьшить его влияние на выполнение пользовательских запросов. Требует наличия расширения Посгреса pg_prioritize-master.

Значение по умолчанию: 0 (не используется).

### `-l STR`

Язык.

Значение по умолчанию: русский.

### `-c STR`

Параметры для подключения к БД поисковика (т.е. БД, содержащей полнотекстовый индекс).

### `-m STR`

Параметры для подключения к основной БД (т.е. БД, содержащей метаданные документов).

### `-a STR`

Параметры для доступа в OpenStack Swift.

### `-g DOCID`

Получить тело документа по заданному DOCID.

### `-e DOCID`

Загрузить письмо по DOCID.

### `-E DOCID`

Загрузить и разобрать письмо.

### `-v DOCID`

Загрузить и верифицировать документ.

### `-0`

Перестройка индекса с нуля.

### `-r`

Вернуть версию индексатора.

### `-i`

Интерактивный режим: ожидает команды пользователя с консоли. Пока поддерживается только команда `exit`.

## FAQ

**Вопрос**: после переезда MyOffice невозможно искать старые документы/почтовые сообщения.

**Ответ**: в штатном режиме надо запустить индексатор с параметром `-0`.

**Вопрос**: нужно ли при этом удалять проиндексированные данные?

**Ответ**: нет. Запуск индексатора с параметром `-0` полностью перестроит индекс, содержимое таблиц будет удалено (при этом таблица не будет дропнута и пересоздана).

**Вопрос**: Нужно ли при этом останавливать штатно работающий индексатор?

**Ответ**: нет. Если индексатор упал или завис или система перезагрузилась, его следует просто перезапустить БЕЗ параметра `-0`. Индексатор продолжит индексацию с того места, где он остановился, и догонет свою базу до текущего состояния основной базы.

**Вопрос**: Как узнать время последней индексации и количество проиндексированных документов?

**Ответ**: в базе `pg_search` есть таблица `ftstate`:

`сreate table ftstate (last_indexed_doc_ts integer, last_indexed_mail_ts integer, n_docs integer, n_mails integer, last_iter_ts timestamp, schema_version integer);`

В ней указывается время последней индексации и чиcло проиндексированных документов.

**Вопрос**: как узнать номер релиза и ревизию формата базы данных, для которой он был собран?

**Ответ**: следует запустить индексатор с опцией `-r`.

**Вопрос**: каков признак окончания переиндексации?

**Ответ**: одним из признаков завершения переиндексации являются стабилизировавшиеся значения проиндексированных документов в таблице `ftstate`.

Естественно, под нагрузкой (т.е. когда на сервер постоянно добавляются новые документы) эти значения никогда не стабилизируются. В этом случае следует обратить внимание на поля `last_indexed_doc_ts integer` и `last_indexed_mail_ts`. Документы индексируются в порядке возрастания их времени изменения. Соответственно, когда индексатор доберётся до текущего состояния базы, эти тайм-стампы будут примерно равны текущему времени.

**Вопрос**: что делать, если схема БД изменилась?

**Ответ**: необходимо пересоздать схему с помощью скрипта `schema_search.sql`, который находится в директории pg_search

`psql -f schema_search.sql`

Этот скрпит удалит все таблицы и функции, используемые поисковиком, и пересоздаст их. Соответственно, при этом потеряются все данные и требуется переиндексация. При запуске индексатора указывать параметр -0 не потребуется (всё и так уже зачищено).
